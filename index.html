<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>ç†±é‡åŠ©æ‰‹ Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ios-blue: #007AFF; --ios-green: #34C759; --ios-orange: #FF9500; --ios-red: #FF3B30; --ios-bg: #F2F2F7; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--ios-bg); margin: 0; padding: 15px; padding-bottom: 80px; }
        .card { background: white; border-radius: 15px; padding: 18px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .user-header { background: var(--ios-blue); color: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        input, select { border: 1px solid #D1D1D6; border-radius: 10px; padding: 12px; font-size: 16px; width: 100%; box-sizing: border-box; }
        button { border: none; border-radius: 12px; padding: 14px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        button:active { opacity: 0.7; }
        .summary-row { display: flex; justify-content: space-around; text-align: center; }
        .summary-item b { font-size: 22px; display: block; color: var(--ios-blue); }
        .chart-container { height: 200px; margin-top: 10px; }
        .log-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 0.5px solid #EEE; font-size: 15px; }
        
        /* é¬§é˜æ¸…å–®æ¨£å¼ */
        .alarm-item { display: flex; justify-content: space-between; align-items: center; background: #F9F9F9; padding: 8px 12px; border-radius: 10px; margin-bottom: 5px; }
        .alarm-item span { font-weight: bold; font-size: 16px; }
        .del-btn { background: var(--ios-red); padding: 5px 10px; font-size: 12px; border-radius: 5px; }
        .notif-banner { background: #5856D6; color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: center; }
    </style>
</head>
<body>

    <div class="user-header">
        <h2 style="margin:0 0 10px 0;">ğŸ‘¤ å¸³è™Ÿï¼š<span id="curUser">è¨ªå®¢</span></h2>
        <div class="grid" style="grid-template-columns: 2fr 1fr;">
            <input type="text" id="accInput" placeholder="åˆ‡æ›åç¨±">
            <button style="background:rgba(255,255,255,0.3);" onclick="switchUser()">åˆ‡æ›</button>
        </div>
    </div>

    <div id="notifPrompt" class="notif-banner">
        è«‹é»æ“Šã€Œé–‹å•Ÿç³»çµ±é€šçŸ¥ã€<br>ä»¥æ¥æ”¶ LINE ç­‰ç´šçš„æé†’æ©«å¹…
        <button style="background: white; color: #5856D6; margin-top: 10px; width: 100%;" onclick="enableNotifications()">ğŸ”” é–‹å•Ÿç³»çµ±é€šçŸ¥</button>
    </div>

    <div class="card">
        <div class="summary-row">
            <div class="summary-item"><small>ç›®æ¨™</small><b id="targetVal">--</b></div>
            <div class="summary-item"><small>æ·¨æ”å–</small><b id="intakeVal">--</b></div>
            <div class="summary-item"><small>å‰©é¤˜</small><b id="remVal">--</b></div>
        </div>
        <div style="text-align: center; margin-top: 15px;">
            <div id="statusIcon" style="font-size:45px;">ğŸŒ±</div>
            <div id="statusLabel" style="font-weight:bold;">è¨­å®šæ•¸æ“šé–‹å§‹ç¨®æ¨¹</div>
        </div>
    </div>

    <div class="card">
        <h2 style="font-size:16px;">â° å¤šæ™‚æ®µæé†’è¨­å®š</h2>
        <div class="grid" style="grid-template-columns: 2fr 1fr;">
            <input type="time" id="newAlarm">
            <button style="background: var(--ios-blue);" onclick="addAlarm()">ï¼‹æ–°å¢</button>
        </div>
        <div id="alarmList" style="margin-top:10px;"></div>
    </div>

    <div class="card">
        <h2 style="font-size:16px;">ğŸ“Š é«”é‡èˆ‡ç†±é‡è¶¨å‹¢</h2>
        <div class="chart-container"><canvas id="myChart"></canvas></div>
    </div>

    <div class="card" style="border-left: 6px solid var(--ios-green);">
        <h2>ğŸ é£²é£Ÿç´€éŒ„</h2>
        <div class="grid" style="grid-template-columns: 2fr 1fr;"><input type="text" id="fn" placeholder="é£Ÿç‰©"><input type="number" id="fc" placeholder="ç†±é‡"></div>
        <button style="background:var(--ios-green);" onclick="addEntry('food')">æ–°å¢é£²é£Ÿ</button>
    </div>

    <div class="card" style="border-left: 6px solid var(--ios-orange);">
        <h2>ğŸƒâ€â™‚ï¸ æ™ºæ…§é‹å‹•</h2>
        <div class="grid" style="grid-template-columns: 2fr 1fr;"><input type="text" id="en" placeholder="é‹å‹•"><input type="number" id="em" placeholder="åˆ†é˜"></div>
        <button style="background:var(--ios-orange);" onclick="addEntry('ex')">è¨ˆç®—æ¶ˆè€—</button>
    </div>

    <div class="card"><h2>ğŸ“‹ ä»Šæ—¥æ˜ç´°</h2><div id="logList"></div></div>

    <script>
        let user = localStorage.getItem('cal_user') || 'Guest';
        let store = JSON.parse(localStorage.getItem('cal_store')) || {};
        // åˆå§‹åŒ–å¸³è™Ÿè³‡æ–™ï¼Œæ–°å¢ alarms é™£åˆ—
        if(!store[user]) store[user] = {h:170, w:60, a:25, alarms:["09:00", "12:00", "19:00"], history:{}, tdee:2000};
        let db = store[user];
        let chart = null;

        const getD = (offset = 0) => {
            const d = new Date(); d.setDate(d.getDate() - offset);
            return d.toISOString().split('T')[0];
        };

        window.onload = () => { 
            loadUser(); 
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js');
            }
            setInterval(checkAlarms, 60000); // æ¯åˆ†é˜æª¢æŸ¥é¬§é˜
            if(Notification.permission === "granted") document.getElementById('notifPrompt').style.display = 'none';
        };

        function loadUser() {
            document.getElementById('curUser').innerText = user;
            renderAlarms();
            refresh();
        }

        function switchUser() {
            const n = document.getElementById('accInput').value.trim();
            if(!n) return;
            store[user] = db;
            user = n;
            localStorage.setItem('cal_user', user);
            if(!store[user]) store[user] = {h:170, w:60, a:25, alarms:["12:00"], history:{}, tdee:2000};
            db = store[user];
            loadUser();
        }

        // é¬§é˜ç®¡ç†é‚è¼¯
        function addAlarm() {
            const time = document.getElementById('newAlarm').value;
            if(!time) return;
            if(!db.alarms) db.alarms = [];
            db.alarms.push(time);
            db.alarms.sort();
            save();
            renderAlarms();
        }

        function deleteAlarm(index) {
            db.alarms.splice(index, 1);
            save();
            renderAlarms();
        }

        function renderAlarms() {
            const list = document.getElementById('alarmList');
            list.innerHTML = (db.alarms || []).map((t, i) => `
                <div class="alarm-item">
                    <span>ğŸ”” ${t}</span>
                    <button class="del-btn" onclick="deleteAlarm(${i})">åˆªé™¤</button>
                </div>
            `).join('');
        }

        // æ ¸å¿ƒé¬§é˜æª¢æŸ¥ (è·³å‡ºåƒ LINE çš„é€šçŸ¥)
        function checkAlarms() {
            const now = new Date();
            const curTime = now.getHours().toString().padStart(2,'0')+":"+now.getMinutes().toString().padStart(2,'0');
            
            // å¦‚æœç•¶å‰æ™‚é–“ç¬¦åˆä»»ä¸€å€‹é¬§é˜
            if ((db.alarms || []).includes(curTime)) {
                // å¦‚æœä»Šå¤©ç´€éŒ„æ¬¡æ•¸å°‘æ–¼ 3 æ¬¡ï¼Œæˆ–è€…æ ¹æ“šä½ çš„éœ€æ±‚è¨­å®šæ¢ä»¶
                sendPushNotification(`å—¨ ${user}ï¼Œè©²ç´€éŒ„ç†±é‡å›‰ï¼`, `ç›®å‰è¨­å®šçš„æé†’æ™‚é–“æ˜¯ ${curTime}ï¼Œè¨˜å¾—å¡«å¯«é£²é£Ÿç´€éŒ„ã€‚`);
            }
        }

        function sendPushNotification(title, body) {
            if (Notification.permission === "granted") {
                navigator.serviceWorker.ready.then(reg => {
                    reg.showNotification(title, {
                        body: body,
                        icon: 'https://cdn-icons-png.flaticon.com/512/2424/2424742.png',
                        badge: 'https://cdn-icons-png.flaticon.com/512/2424/2424742.png',
                        vibrate: [200, 100, 200]
                    });
                });
            } else {
                alert("â° " + title);
            }
        }

        function enableNotifications() {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    document.getElementById('notifPrompt').style.display = 'none';
                    sendPushNotification("é€šçŸ¥å·²å•Ÿå‹•", "ç¾åœ¨æ™‚é–“åˆ°æ™‚ï¼Œä½ æœƒæ”¶åˆ°åƒé€™æ¨£çš„æ©«å¹…é€šçŸ¥ã€‚");
                }
            });
        }

        // ç´€éŒ„èˆ‡å­˜æª” (ä¿æŒä¸è®Š)
        function addEntry(type) {
            const date = getD();
            if(!db.history[date]) db.history[date] = [];
            if(type==='food') {
                const n=document.getElementById('fn').value, c=parseInt(document.getElementById('fc').value);
                if(n && c) db.history[date].push({n, c});
                document.getElementById('fn').value=''; document.getElementById('fc').value='';
            } else {
                const n=document.getElementById('en').value, m=parseInt(document.getElementById('em').value);
                if(n && m) {
                    const met = n.includes("è·‘")?8.5:n.includes("èµ°")?3.5:4.5;
                    db.history[date].push({n:n+`(${m}åˆ†)`, c:-Math.round(met*db.w*(m/60))});
                }
                document.getElementById('en').value=''; document.getElementById('em').value='';
            }
            save();
        }

        function save() { store[user]=db; localStorage.setItem('cal_store', JSON.stringify(store)); refresh(); }

        function refresh() {
            const today = getD();
            const logs = db.history[today] || [];
            const intake = logs.reduce((s,i)=>s+i.c, 0);
            const rem = db.tdee - intake;
            document.getElementById('targetVal').innerText = db.tdee;
            document.getElementById('intakeVal').innerText = intake;
            document.getElementById('remVal').innerText = rem;
            
            let icon="ğŸŒ±", txt="åŠ æ²¹ï¼";
            if(logs.length>0) {
                if(rem>300){icon="ğŸŒ³"; txt="å¾ˆæ£’å•Šï¼";}
                else if(rem>=0){icon="ğŸ"; txt="ä¸€è¨‚çš„å•Šï¼";}
                else {icon="ğŸ’€"; txt="é ¹å»¢ï¼polk è¦ä¾†äº†";}
            }
            document.getElementById('statusIcon').innerText=icon;
            document.getElementById('statusLabel').innerText=txt;
            document.getElementById('logList').innerHTML = logs.map(l=>`<div class="log-item"><span>${l.n}</span><b>${l.c>0?'+':''}${l.c}</b></div>`).reverse().join('');
            renderChart(7);
        }

        function renderChart(days) {
            const labels = [], vals = [];
            for(let i=days-1; i>=0; i--) {
                const d = getD(i);
                labels.push(d.split('-')[2]+'æ—¥');
                vals.push((db.history[d] || []).reduce((s,l)=>s+l.c, 0));
            }
            if(chart) chart.destroy();
            chart = new Chart(document.getElementById('myChart'), {
                type: 'line',
                data: { labels, datasets: [{ label:'ç†±é‡', data:vals, borderColor:'#007AFF', tension:0.3 }] },
                options: { responsive:true, maintainAspectRatio:false }
            });
        }
    </script>
</body>
</html>