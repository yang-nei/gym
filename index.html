<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>AI å¥åº·åŠ©æ‰‹ (å°æ¨¹å›æ­¸ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ios-blue: #007AFF; --ios-green: #34C759; --ios-orange: #FF9500; --ios-red: #FF3B30; --ios-bg: #F2F2F7; --ai-purple: #5856D6; }
        body { font-family: -apple-system, sans-serif; background: var(--ios-bg); margin: 0; padding: 15px; padding-bottom: 60px; color: #1C1C1E; }
        .card { background: white; border-radius: 18px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .user-header { background: linear-gradient(135deg, var(--ios-blue), #0056b3); color: white; padding: 20px; border-radius: 18px; margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        input, textarea { border: 1.5px solid #E5E5EA; border-radius: 12px; padding: 14px; font-size: 16px; width: 100%; box-sizing: border-box; }
        button { border: none; border-radius: 14px; padding: 14px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        .summary-row { display: flex; justify-content: space-around; text-align: center; }
        .summary-item b { font-size: 24px; display: block; color: var(--ios-blue); }
        .ai-btn { background: var(--ai-purple); width: 100%; }
        .status-area { text-align: center; margin-top: 15px; border-top: 1px solid #F2F2F7; padding-top: 15px; }
        .ai-loading { color: var(--ai-purple); font-size: 13px; display: none; text-align: center; margin: 10px 0; font-weight: bold; }
        .log-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 0.5px solid #EEE; }
        #preview { width: 100%; border-radius: 12px; margin-top: 10px; display: none; }
        .notif-banner { background: var(--ai-purple); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; text-align: center; }
    </style>
</head>
<body>

    <div class="user-header">
        <h2>ğŸ‘¤ <span id="curUser">è¨ªå®¢</span></h2>
        <div class="grid" style="grid-template-columns: 2fr 1fr;">
            <input type="text" id="accInput" placeholder="åˆ‡æ›å¸³è™Ÿ">
            <button style="background:rgba(255,255,255,0.2);" onclick="switchUser()">åˆ‡æ›</button>
        </div>
    </div>

    <div id="notifPrompt" class="notif-banner" onclick="enableEverything()">
        ğŸ”” é»æ­¤æˆæ¬Šï¼šå•Ÿå‹• AI è¾¨è­˜ã€è¨ˆæ­¥èˆ‡é€šçŸ¥
    </div>

    <div class="card">
        <div class="summary-row">
            <div class="summary-item"><small>ç›®æ¨™</small><b id="targetVal">--</b></div>
            <div class="summary-item"><small>æ”å–</small><b id="intakeVal">--</b></div>
            <div class="summary-item"><small>å‰©é¤˜</small><b id="remVal">--</b></div>
        </div>
        <div class="status-area">
            <div id="statusIcon" style="font-size:50px;">ğŸŒ±</div>
            <div id="statusLabel" style="font-weight:700; margin-top:5px;">é–‹å§‹ç´€éŒ„ä»Šæ—¥çš„ç¬¬ä¸€é¤å§ï¼</div>
        </div>
    </div>

    <div class="card" style="border: 2px solid var(--ai-purple);">
        <h2 style="color: var(--ai-purple); margin:0 0 10px 0;">ğŸª„ AI æ™ºæ…§è¾¨è­˜</h2>
        <textarea id="aiInput" placeholder="è¼¸å…¥æ–‡å­—æˆ–æ‹ç…§..." rows="2"></textarea>
        <div class="grid" style="margin-top:10px;">
            <button class="ai-btn" onclick="askAI()">æ–‡å­—åˆ†æ</button>
            <button class="ai-btn" style="background:var(--ios-green);" onclick="document.getElementById('imgIn').click()">ğŸ“· æ‹ç…§è¾¨è­˜</button>
        </div>
        <input type="file" id="imgIn" accept="image/*" capture="environment" style="display:none;" onchange="analyzeImage(this)">
        <div id="aiLoading" class="ai-loading">âœ¨ Gemini æ­£åœ¨åˆ†æ...</div>
        <img id="preview">
    </div>

    <div class="card">
        <h2>ğŸƒ é‹å‹•ç´€éŒ„</h2>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div><b style="font-size:28px;"><span id="liveSteps">0</span> æ­¥</b><br><small id="liveDist">0.00</small> km</div>
            <button id="stepBtn" style="background: var(--ios-blue); padding: 12px 20px;" onclick="togglePedometer()">é–‹å§‹è¨ˆæ­¥</button>
        </div>
        <div class="grid" style="grid-template-columns: 2fr 1fr;">
            <input type="text" id="en" placeholder="é‹å‹•å…§å®¹">
            <input type="number" id="em" placeholder="åˆ†">
        </div>
        <button style="background:var(--ios-orange); width:100%; margin-top:10px;" onclick="addEntry('ex')">æ‰‹å‹•æ–°å¢é‹å‹•</button>
    </div>

    <div class="card">
        <h2>âš™ï¸ èº«é«”è¨­å®š</h2>
        <div class="grid">
            <input type="number" id="h" placeholder="èº«é«˜ cm">
            <input type="number" id="w" placeholder="é«”é‡ kg">
            <input type="number" id="a" placeholder="å¹´é½¡">
            <button style="background: var(--ios-blue); grid-column: span 2;" onclick="updateProfile()">å„²å­˜ä¸¦è¨ˆç®— TDEE</button>
        </div>
    </div>

    <div class="card"><h2>ğŸ“‹ ä»Šæ—¥ç´€éŒ„</h2><div id="logList"></div></div>

    <script>
        const API_KEY = "AIzaSyADqOezfr_Yz1RXVnxaKU5_Pi1IZP4NnX4"; 

        let user = localStorage.getItem('cal_user') || 'Guest';
        let store = JSON.parse(localStorage.getItem('cal_store')) || {};
        if(!store[user]) store[user] = {h:170, w:60, a:25, alarms:["12:00", "19:00"], history:{}, tdee:2000};
        let db = store[user];
        let stepCount = 0, isStepTracking = false, lastAccel = {x:0, y:0, z:0};

        const getD = (offset = 0) => {
            const d = new Date(); d.setDate(d.getDate() - offset);
            return d.toISOString().split('T')[0];
        };

        window.onload = () => { loadUser(); setInterval(checkAlarms, 60000); };

        // --- å°æ¨¹é‚è¼¯èˆ‡ä»‹é¢æ›´æ–° ---
        function refresh() {
            const today = getD();
            const logs = db.history[today] || [];
            const intake = logs.reduce((s,i)=>s+i.c, 0);
            const rem = db.tdee - intake;

            document.getElementById('targetVal').innerText = db.tdee;
            document.getElementById('intakeVal').innerText = intake;
            document.getElementById('remVal').innerText = rem;

            // ğŸŒ³ å°æ¨¹ç‹€æ…‹æ›´æ–°é‚è¼¯
            let icon = "ğŸŒ±", txt = "æº–å‚™å¥½é–‹å§‹æ–°çš„ä¸€å¤©äº†å—ï¼Ÿ";
            if (logs.length > 0) {
                if (rem > 500) { icon = "ğŸŒ³"; txt = "ç‹€æ…‹éå¸¸å¥½ï¼Œç¹¼çºŒä¿æŒï¼"; }
                else if (rem >= 0) { icon = "ğŸ"; txt = "å®Œç¾çš„æ§åˆ¶ï¼Œä½ æ˜¯è‡ªå¾‹å¤§å¸«ï¼"; }
                else { icon = "ğŸ’€"; txt = "ç†±é‡è¶…æ¨™äº†ï¼å¿«å»é‹å‹•ä¸€ä¸‹ï¼"; }
            }
            document.getElementById('statusIcon').innerText = icon;
            document.getElementById('statusLabel').innerText = txt;

            document.getElementById('logList').innerHTML = logs.map(l=>`<div class="log-item"><span>${l.n}</span><b style="color:${l.c>0?'var(--ios-red)':'var(--ios-blue)'}">${l.c>0?'+':''}${l.c}</b></div>`).reverse().join('');
        }

        // --- AI åŠŸèƒ½ ---
        async function askAI() {
            const text = document.getElementById('aiInput').value.trim();
            if(!text) return;
            document.getElementById('aiLoading').style.display = "block";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `åˆ†æã€Œ${text}ã€ï¼Œåƒ…å›å‚³ JSONï¼š{"cal": æ•¸å­—, "desc": "ç°¡çŸ­æ‘˜è¦"}` }] }] })
                });
                const data = await response.json();
                const json = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, ""));
                if(confirm(`AI ä¼°ç®—ï¼š${json.desc} (${json.cal}å¤§å¡)ï¼Œè¦ç´€éŒ„å—ï¼Ÿ`)) recordData("ğŸª„ " + json.desc, json.cal);
                document.getElementById('aiInput').value = "";
            } catch (e) { alert("AI åˆ†æå¤±æ•—ã€‚"); }
            finally { document.getElementById('aiLoading').style.display = "none"; }
        }

        async function analyzeImage(input) {
            if (!input.files?.[0]) return;
            const file = input.files[0];
            document.getElementById('preview').src = URL.createObjectURL(file);
            document.getElementById('preview').style.display = "block";
            document.getElementById('aiLoading').style.display = "block";
            const base64 = (await toBase64(file)).split(',')[1];
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [
                        { text: "ä½ æ˜¯ç‡Ÿé¤Šå¸«ï¼Œçœ‹ç…§ç‰‡ä¼°ç®—ç†±é‡ï¼Œå›å‚³ JSONï¼š{\"cal\": æ•¸å­—, \"desc\": \"é£Ÿç‰©(ç†±é‡)\"}" },
                        { inline_data: { mime_type: file.type, data: base64 } }
                    ] }] })
                });
                const data = await response.json();
                const json = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, ""));
                if(confirm(`ğŸ“¸ AI è¾¨è­˜ï¼š${json.desc}ï¼Œè¦ç´€éŒ„å—ï¼Ÿ`)) recordData("ğŸ“¸ " + json.desc, json.cal);
            } catch (e) { alert("è¾¨è­˜å¤±æ•—ã€‚"); }
            finally { document.getElementById('aiLoading').style.display = "none"; document.getElementById('preview').style.display = "none"; }
        }

        // --- å…¶ä»–ç³»çµ±åŠŸèƒ½ ---
        function recordData(n, c) {
            const d = getD(); if(!db.history[d]) db.history[d] = [];
            db.history[d].push({n, c}); save();
        }

        function checkAlarms() {
            const cur = new Date().getHours().toString().padStart(2,'0')+":"+new Date().getMinutes().toString().padStart(2,'0');
            if (db.alarms.includes(cur)) {
                const w = getSummary(7), m = getSummary(30);
                const msg = `é€±å¹³å‡ï¼š${w.avg} | æœˆå¹³å‡ï¼š${m.avg}`;
                if (Notification.permission === "granted") new Notification("å¥åº·å ±å‘Š", { body: msg });
                else alert("ğŸ”” å®šæ™‚å ±å‘Šï¼š\n" + msg);
            }
        }

        function getSummary(days) {
            let total = 0, count = 0;
            for(let i=0; i<days; i++) {
                const daySum = (db.history[getD(i)] || []).reduce((s,l)=>s+l.c, 0);
                if(daySum > 0) { total += daySum; count++; }
            }
            const avg = count > 0 ? Math.round(total / count) : 0;
            return { avg, status: avg > db.tdee ? "è¶…æ¨™" : "æ­£å¸¸" };
        }

        function togglePedometer() {
            if (!isStepTracking) {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission().then(s => { if(s==='granted') startSteps(); });
                } else { startSteps(); }
            } else { stopSteps(); }
        }

        function startSteps() { isStepTracking = true; stepCount = 0; document.getElementById('stepBtn').innerText = "åœæ­¢ç´€éŒ„"; window.addEventListener('devicemotion', handleMotion); }
        function stopSteps() { 
            isStepTracking = false; window.removeEventListener('devicemotion', handleMotion);
            const dist = (stepCount * db.h * 0.45 / 100 / 1000).toFixed(2);
            if(stepCount > 20) recordData(`ğŸš¶ è¡Œèµ° ${stepCount}æ­¥`, -Math.round(db.w * 0.5 * dist));
            document.getElementById('stepBtn').innerText = "é–‹å§‹è¨ˆæ­¥"; stepCount = 0; updateStepUI();
        }
        function handleMotion(e) {
            let acc = e.accelerationIncludingGravity;
            let change = Math.abs(acc.x + acc.y + acc.z - lastAccel.x - lastAccel.y - lastAccel.z);
            if (change > 13) { stepCount++; updateStepUI(); }
            lastAccel = {x:acc.x, y:acc.y, z:acc.z};
        }
        function updateStepUI() {
            document.getElementById('liveSteps').innerText = stepCount;
            document.getElementById('liveDist').innerText = (stepCount * db.h * 0.45 / 100 / 1000).toFixed(2);
        }

        function updateProfile() {
            db.h = parseFloat(document.getElementById('h').value) || 170;
            db.w = parseFloat(document.getElementById('w').value) || 60;
            db.a = parseInt(document.getElementById('a').value) || 25;
            db.tdee = Math.round((10 * db.w + 6.25 * db.h - 5 * db.a + 5) * 1.2);
            save(); alert("æ•¸æ“šå·²æ›´æ–°ï¼");
        }

        function enableEverything() { Notification.requestPermission(); togglePedometer(); setTimeout(stopSteps, 500); document.getElementById('notifPrompt').style.display = "none"; }
        const toBase64 = f => new Promise((v,j)=>{const r=new FileReader(); r.readAsDataURL(f); r.onload=()=>v(r.result); r.onerror=e=>j(e);});
        function save() { store[user]=db; localStorage.setItem('cal_store', JSON.stringify(store)); refresh(); }
        function loadUser() { document.getElementById('curUser').innerText = user; document.getElementById('h').value = db.h; document.getElementById('w').value = db.w; document.getElementById('a').value = db.a; refresh(); }
        function addEntry(type) {
            const n=document.getElementById('en').value, m=parseInt(document.getElementById('em').value);
            if(n && m) { recordData(`${n}(${m}åˆ†)`, -Math.round(4.5 * db.w * (m/60))); document.getElementById('en').value=''; document.getElementById('em').value=''; }
        }
        function switchUser() {
            const n = document.getElementById('accInput').value.trim();
            if(n) { user=n; if(!store[user]) store[user]={h:170, w:60, a:25, alarms:["12:00"], history:{}, tdee:2000}; db=store[user]; save(); loadUser(); }
        }
    </script>
</body>
</html>