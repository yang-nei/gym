<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>ç†±é‡åŠ©æ‰‹ Pro+</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ios-blue: #007AFF; --ios-green: #34C759; --ios-orange: #FF9500; --ios-red: #FF3B30; --ios-bg: #F2F2F7; }
        body { font-family: -apple-system, sans-serif; background: var(--ios-bg); margin: 0; padding: 15px; padding-bottom: 60px; color: #1C1C1E; }
        .card { background: white; border-radius: 18px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .user-header { background: linear-gradient(135deg, var(--ios-blue), #0056b3); color: white; padding: 22px; border-radius: 18px; margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        input { border: 1.5px solid #E5E5EA; border-radius: 12px; padding: 14px; font-size: 16px; width: 100%; box-sizing: border-box; background: #FAFAFA; }
        button { border: none; border-radius: 14px; padding: 14px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        button:active { transform: scale(0.98); opacity: 0.8; }
        .summary-row { display: flex; justify-content: space-around; text-align: center; }
        .summary-item b { font-size: 24px; display: block; color: var(--ios-blue); }
        .status-area { text-align: center; margin-top: 15px; border-top: 1px solid #F2F2F7; padding-top: 15px; }
        .chart-container { height: 200px; margin-top: 10px; }
        .alarm-item { display: flex; justify-content: space-between; align-items: center; background: #F2F2F7; padding: 12px; border-radius: 12px; margin-bottom: 8px; }
        .notif-banner { background: #5856D6; color: white; padding: 18px; border-radius: 18px; margin-bottom: 15px; text-align: center; }
        .pedometer-active { background: #E8F2FF; border: 2px solid var(--ios-blue); }
        h2 { font-size: 18px; margin: 0 0 12px 0; font-weight: 700; }
    </style>
</head>
<body>

    <div class="user-header">
        <h2 style="color:white; margin-bottom:15px;">ğŸ‘¤ å¸³è™Ÿï¼š<span id="curUser">è¨ªå®¢</span></h2>
        <div class="grid" style="grid-template-columns: 2.5fr 1fr;">
            <input type="text" id="accInput" placeholder="åˆ‡æ›åç¨±">
            <button style="background:rgba(255,255,255,0.25);" onclick="switchUser()">åˆ‡æ›</button>
        </div>
    </div>

    <div id="notifPrompt" class="notif-banner">
        ğŸ”” å•Ÿå‹•ã€Œæ™ºæ…§é€šçŸ¥ã€èˆ‡ã€Œæ„Ÿæ¸¬å™¨ã€
        <button style="background: white; color: #5856D6; margin-top: 12px; width: 100%;" onclick="enableEverything()">ç«‹å³æˆæ¬Š</button>
    </div>

    <div class="card">
        <div class="summary-row">
            <div class="summary-item"><small>ç›®æ¨™</small><b id="targetVal">--</b></div>
            <div class="summary-item"><small>ä»Šæ—¥æ”å–</small><b id="intakeVal">--</b></div>
            <div class="summary-item"><small>å‰©é¤˜</small><b id="remVal">--</b></div>
        </div>
        <div class="status-area">
            <div id="statusIcon" style="font-size:50px;">ğŸŒ±</div>
            <div id="statusLabel" style="font-weight:700;">è¨­å®šæ•¸æ“šé–‹å§‹ç´€éŒ„</div>
        </div>
    </div>

    <div class="card" id="stepCard">
        <h2>ğŸƒ å³æ™‚è¨ˆæ­¥èˆ‡è·é›¢</h2>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <span style="font-size: 14px; color: #666;">æœ¬æ¬¡è¡Œèµ°</span>
                <div style="font-size: 32px; font-weight: bold;"><span id="liveSteps">0</span> æ­¥</div>
                <div style="font-size: 14px; color: var(--ios-blue); font-weight: 600;">ä¼°è¨ˆè·é›¢: <span id="liveDist">0.00</span> km</div>
            </div>
            <button id="stepBtn" style="background: var(--ios-blue); padding: 15px 25px;" onclick="togglePedometer()">é–‹å§‹è¨ˆæ­¥</button>
        </div>
    </div>

    <div class="card">
        <h2>âš™ï¸ èº«é«”æ•¸æ“šè¨­å®š</h2>
        <div class="grid">
            <input type="number" id="h" placeholder="èº«é«˜ cm">
            <input type="number" id="w" placeholder="é«”é‡ kg">
            <input type="number" id="a" placeholder="å¹´é½¡">
            <button style="background: var(--ios-blue); grid-column: span 2;" onclick="updateProfile()">å„²å­˜å€‹äººåŒ–æ•¸æ“š</button>
        </div>
    </div>

    <div class="card">
        <h2>â° å¤šæ™‚æ®µæ™ºæ…§æé†’</h2>
        <div class="grid" style="grid-template-columns: 2fr 1fr;">
            <input type="time" id="newAlarm">
            <button style="background: var(--ios-orange);" onclick="addAlarm()">ï¼‹æ–°å¢</button>
        </div>
        <div id="alarmList"></div>
    </div>

    <div class="card">
        <h2>ğŸ“Š ç†±é‡è¶¨å‹¢</h2>
        <div class="chart-container"><canvas id="myChart"></canvas></div>
    </div>

    <div class="card" style="border-top: 6px solid var(--ios-green);">
        <h2>ğŸ é£²é£Ÿç´€éŒ„</h2>
        <div class="grid" style="grid-template-columns: 2fr 1fr;"><input type="text" id="fn" placeholder="é£Ÿç‰©"><input type="number" id="fc" placeholder="å¤§å¡"></div>
        <button style="background:var(--ios-green); width:100%;" onclick="addEntry('food')">æ–°å¢é£²é£Ÿ</button>
    </div>

    <div class="card"><h2>ğŸ“‹ ä»Šæ—¥ç´€éŒ„</h2><div id="logList"></div></div>

    <script>
        let user = localStorage.getItem('cal_user') || 'Guest';
        let store = JSON.parse(localStorage.getItem('cal_store')) || {};
        if(!store[user]) store[user] = {h:170, w:60, a:25, alarms:["12:00"], history:{}, tdee:2000};
        let db = store[user];
        let chart = null, stepCount = 0, isStepTracking = false, lastAccel = {x:0, y:0, z:0};

        const getD = (offset = 0) => {
            const d = new Date(); d.setDate(d.getDate() - offset);
            return d.toISOString().split('T')[0];
        };

        window.onload = () => { 
            loadUser(); 
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js');
            setInterval(checkAlarms, 60000);
            if(Notification.permission === "granted") document.getElementById('notifPrompt').style.display = 'none';
        };

        function switchUser() {
            const n = document.getElementById('accInput').value.trim();
            if(!n) return;
            store[user] = db;
            user = n;
            localStorage.setItem('cal_user', user);
            if(!store[user]) store[user] = {h:170, w:60, a:25, alarms:[], history:{}, tdee:2000};
            db = store[user];
            loadUser();
        }

        function loadUser() {
            document.getElementById('curUser').innerText = user;
            document.getElementById('h').value = db.h || '';
            document.getElementById('w').value = db.w || '';
            document.getElementById('a').value = db.a || '';
            renderAlarms();
            refresh();
        }

        function updateProfile() {
            db.h = parseFloat(document.getElementById('h').value) || 170;
            db.w = parseFloat(document.getElementById('w').value) || 60;
            db.a = parseInt(document.getElementById('a').value) || 25;
            db.tdee = Math.round((10 * db.w + 6.25 * db.h - 5 * db.a + 5) * 1.2);
            save();
            alert("æ•¸æ“šå·²åŒæ­¥ï¼");
        }

        // --- è¨ˆæ­¥å™¨æ ¸å¿ƒé‚è¼¯ ---
        function togglePedometer() {
            if (!isStepTracking) {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission().then(state => { if (state === 'granted') startSteps(); });
                } else { startSteps(); }
            } else { stopSteps(); }
        }

        function startSteps() {
            isStepTracking = true;
            stepCount = 0;
            document.getElementById('stepBtn').innerText = "åœæ­¢ç´€éŒ„";
            document.getElementById('stepBtn').style.background = "var(--ios-red)";
            document.getElementById('stepCard').classList.add('pedometer-active');
            window.addEventListener('devicemotion', handleMotion);
        }

        function stopSteps() {
            isStepTracking = false;
            window.removeEventListener('devicemotion', handleMotion);
            const dist = parseFloat(document.getElementById('liveDist').innerText);
            if(stepCount > 50) { // èµ°è¶…é50æ­¥æ‰ç´€éŒ„
                const cal = Math.round(db.w * 0.5 * dist);
                const date = getD();
                if(!db.history[date]) db.history[date] = [];
                db.history[date].push({n: `ğŸš¶ è¡Œèµ° ${stepCount}æ­¥ (${dist}km)`, c: -cal});
                save();
                alert(`è¾›è‹¦äº†ï¼è¡Œèµ° ${dist}kmï¼Œæ¶ˆè€— ${cal} å¤§å¡`);
            }
            document.getElementById('stepBtn').innerText = "é–‹å§‹è¨ˆæ­¥";
            document.getElementById('stepBtn').style.background = "var(--ios-blue)";
            document.getElementById('stepCard').classList.remove('pedometer-active');
            stepCount = 0;
            updateStepUI();
        }

        function handleMotion(e) {
            let acc = e.accelerationIncludingGravity;
            let change = Math.abs(acc.x + acc.y + acc.z - lastAccel.x - lastAccel.y - lastAccel.z);
            if (change > 13) { stepCount++; updateStepUI(); }
            lastAccel = {x:acc.x, y:acc.y, z:acc.z};
        }

        function updateStepUI() {
            document.getElementById('liveSteps').innerText = stepCount;
            const stride = (db.h * 0.45) / 100;
            document.getElementById('liveDist').innerText = ((stepCount * stride) / 1000).toFixed(2);
        }

        // --- é€šçŸ¥èˆ‡ç¸½çµé‚è¼¯ ---
        function getSummary(days) {
            let total = 0, count = 0;
            for(let i=0; i<days; i++) {
                const daySum = (db.history[getD(i)] || []).reduce((s,l)=>s+l.c, 0);
                if(daySum > 0) { total += daySum; count++; }
            }
            const avg = count > 0 ? Math.round(total / count) : 0;
            return { avg, status: avg > db.tdee ? "è¶…æ¨™" : "æ­£å¸¸" };
        }

        function checkAlarms() {
            const cur = new Date().getHours().toString().padStart(2,'0')+":"+new Date().getMinutes().toString().padStart(2,'0');
            if ((db.alarms || []).includes(cur)) {
                const w = getSummary(7), m = getSummary(30);
                sendPush(`ç´€éŒ„æ™‚é–“åˆ°å›‰ï¼`, `ä»Šæ—¥å‰©é¤˜ï¼š${document.getElementById('remVal').innerText} kcal\né€±å‡ï¼š${w.avg} (${w.status}) | æœˆå‡ï¼š${m.avg} (${m.status})`);
            }
        }

        function sendPush(t, b) {
            if (Notification.permission === "granted") {
                navigator.serviceWorker.ready.then(reg => reg.showNotification(t, {body:b, icon:'https://cdn-icons-png.flaticon.com/512/2424/2424742.png'}));
            }
        }

        function enableEverything() {
            Notification.requestPermission().then(p => {
                if(p==='granted') document.getElementById('notifPrompt').style.display='none';
            });
            togglePedometer(); // è§¸ç™¼æ„Ÿæ¸¬å™¨æ¬Šé™è«‹æ±‚
            setTimeout(stopSteps, 500);
        }

        // --- ç´€éŒ„èˆ‡å­˜æª” ---
        function addEntry(type) {
            const date = getD();
            if(!db.history[date]) db.history[date] = [];
            const n=document.getElementById('fn').value, c=parseInt(document.getElementById('fc').value);
            if(n && c) db.history[date].push({n, c});
            document.getElementById('fn').value=''; document.getElementById('fc').value='';
            save();
        }

        function addAlarm() {
            const t = document.getElementById('newAlarm').value;
            if(t) { db.alarms.push(t); db.alarms.sort(); save(); renderAlarms(); }
        }
        function deleteAlarm(i) { db.alarms.splice(i, 1); save(); renderAlarms(); }
        function renderAlarms() {
            document.getElementById('alarmList').innerHTML = (db.alarms || []).map((t, i) => `
                <div class="alarm-item"><span>ğŸ”” ${t}</span><button style="background:var(--ios-red); padding:6px 10px; font-size:12px;" onclick="deleteAlarm(${i})">åˆªé™¤</button></div>
            `).join('');
        }

        function save() { store[user]=db; localStorage.setItem('cal_store', JSON.stringify(store)); refresh(); }

        function refresh() {
            const today = getD();
            const logs = db.history[today] || [];
            const intake = logs.reduce((s,i)=>s+i.c, 0);
            const rem = db.tdee - intake;
            document.getElementById('targetVal').innerText = db.tdee;
            document.getElementById('intakeVal').innerText = intake;
            document.getElementById('remVal').innerText = rem;
            
            let icon="ğŸŒ±", txt="åŠ æ²¹ï¼";
            if(logs.length > 0) {
                if(rem > 300) {icon="ğŸŒ³"; txt="å¾ˆæ£’å•Šï¼";}
                else if(rem >= 0) {icon="ğŸ"; txt="ä¸€å®šè¦çš„å•Šï¼";}
                else {icon="ğŸ’€"; txt="é ¹å»¢ polk åœ¨å¾Œé¢ï¼";}
            }
            document.getElementById('statusIcon').innerText=icon;
            document.getElementById('statusLabel').innerText=txt;
            document.getElementById('logList').innerHTML = logs.map(l=>`<div class="log-item"><span>${l.n}</span><b style="color:${l.c>0?'var(--ios-red)':'var(--ios-blue)'}">${l.c>0?'+':''}${l.c}</b></div>`).reverse().join('');
            renderChart(7);
        }

        function renderChart(days) {
            const labels = [], vals = [];
            for(let i=days-1; i>=0; i--) {
                const d = getD(i);
                labels.push(d.split('-')[2]+'æ—¥');
                vals.push((db.history[d] || []).reduce((s,l)=>s+l.c, 0));
            }
            if(chart) chart.destroy();
            chart = new Chart(document.getElementById('myChart'), {
                type: 'line',
                data: { labels, datasets: [{ label:'ç†±é‡', data:vals, borderColor:'#007AFF', tension:0.4, fill:true, backgroundColor:'rgba(0,122,255,0.1)' }] },
                options: { responsive:true, maintainAspectRatio:false }
            });
        }
    </script>
</body>
</html>